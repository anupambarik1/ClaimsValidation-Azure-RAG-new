<div class="chat-container">
  <!-- Header Bar -->
  <mat-toolbar color="primary" class="chat-header">
    <mat-icon>smart_toy</mat-icon>
    <span>Claims Assistant</span>
    <span class="spacer"></span>
    
    @if (awaitingSupportingDocs && pendingClaim) {
      <div class="pending-claim-badge">
        <mat-icon>pending_actions</mat-icon>
        <span>{{ supportingDocuments.length }} docs uploaded</span>
        <button mat-raised-button color="accent" (click)="finalizeClaim()" class="finalize-btn">
          Finalize Claim
        </button>
        <button mat-icon-button (click)="cancelPendingClaim()" matTooltip="Cancel pending claim">
          <mat-icon>cancel</mat-icon>
        </button>
      </div>
    }
    
    <button mat-icon-button (click)="clearChat()" matTooltip="Clear chat">
      <mat-icon>delete_sweep</mat-icon>
    </button>
  </mat-toolbar>

  <!-- Main Content Area - Split Vertically -->
  <div class="main-content">
    <!-- Left Panel - Input Section -->
    <div class="left-panel">
      <div class="panel-header">
        <mat-icon>edit_note</mat-icon>
        <h3>Submit Claim</h3>
      </div>
      
      <div class="input-container">
        <mat-tab-group #tabGroup>
          <mat-tab label="Text Input">
            <div class="text-input-panel">
              <mat-form-field appearance="outline" class="message-input">
                <mat-label>Type a message...</mat-label>
                <textarea
                  matInput
                  [(ngModel)]="userMessage"
                  (keydown.enter)="handleEnter($event)"
                  rows="2"
                  placeholder="Ask about claims or upload documents..."></textarea>
              </mat-form-field>
              <button mat-fab color="primary" (click)="sendMessage()" [disabled]="!userMessage.trim()">
                <mat-icon>send</mat-icon>
              </button>
            </div>
          </mat-tab>
          
          <mat-tab label="Upload Claim Form">
            <app-document-upload 
              [mode]="'claim'"
              (documentSubmitted)="handleDocumentSubmit($event)">
            </app-document-upload>
          </mat-tab>
          
          <mat-tab label="Manual Claim Entry">
            <app-claim-form (claimSubmitted)="handleClaimSubmit($event)"></app-claim-form>
          </mat-tab>
          
          <mat-tab label="Upload Supporting Docs">
            @if (!awaitingSupportingDocs) {
              <div class="info-panel">
                <mat-icon>info</mat-icon>
                <p>Upload supporting documents AFTER submitting a claim.</p>
                <p>First, submit a claim using "Upload Claim Form" or "Manual Claim Entry" tabs.</p>
              </div>
            } @else {
              <app-document-upload 
                [mode]="'supporting'"
                (supportingDocsUploaded)="handleSupportingDocsUpload($event)">
              </app-document-upload>
            }
          </mat-tab>
          
          <mat-tab label="Search Claims">
            <app-claim-search></app-claim-search>
          </mat-tab>
        </mat-tab-group>
      </div>
    </div>

    <!-- Right Panel - Messages/Results Section -->
    <div class="right-panel">
      <div class="panel-header">
        <mat-icon>chat_bubble</mat-icon>
        <h3>Processing & Results</h3>
      </div>
      
      <div class="messages-container" #messagesContainer>
    @for (message of messages$ | async; track message.id) {
      <div class="message" [class.user-message]="message.sender === 'user'" [class.bot-message]="message.sender === 'bot'">
        <div class="message-avatar">
          <mat-icon>{{ message.sender === 'user' ? 'person' : 'smart_toy' }}</mat-icon>
        </div>
        <div class="message-content">
          <div class="message-header">
            <span class="message-sender">{{ message.sender === 'user' ? 'You' : 'Assistant' }}</span>
            <span class="message-time">{{ message.timestamp | date:'short' }}</span>
          </div>
          
          @if (message.type === 'text') {
            <div class="message-text">{{ message.content }}</div>
          }
          
          @if (message.type === 'document') {
            <div class="message-document">
              <mat-icon>description</mat-icon>
              <span>{{ message.content }}</span>
            </div>
          }
          
          @if (message.type === 'result' && message.data) {
            <app-claim-result 
              [result]="message.data"
              (confirmAndSubmit)="handleConfirmAndSubmit($event)"
              (editClaim)="handleEditClaim($event)">
            </app-claim-result>
          }
        </div>
      </div>
    }
    
    @if (isLoading) {
      <div class="message bot-message">
        <div class="message-avatar">
          <mat-icon>smart_toy</mat-icon>
        </div>
        <div class="message-content">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    }
      </div>
    </div>
  </div>
</div>
